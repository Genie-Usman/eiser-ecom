<section class="py-10 md:py-14">
  <div
    class="container mx-auto px-20"
    data-cart-root
    data-section-id="{{ section.id }}">
    {% if cart.item_count == 0 %}
      <p class="mt-6 text-[#797979]">Your cart is currently empty.</p>
      <div class="mt-4">
        <a href="{{ routes.all_products_collection_url }}" class="inline-flex h-10 px-6 items-center justify-center border border-gray-300 text-[#2A2A2A] rounded hover:border-gray-400">Continue shopping</a>
      </div>
    {% else %}
      <form
        action="{{ routes.cart_url }}"
        method="post"
        class="mt-6 grid lg:grid-cols-12 gap-8"
        data-cart-form>
        <!-- Items list -->
        <div class="lg:col-span-12">
          <!-- Header (same as yours) -->
          <div class="hidden md:grid grid-cols-12 text-xs font-medium border-b border-gray-200 uppercase tracking-wide text-[#797979] px-5 py-3">
            <div class="col-span-7">Product</div>
            <div class="col-span-2 text-center">Price</div>
            <div class="col-span-1 text-center">Quantity</div>
            <div class="col-span-2 text-right">Total</div>
          </div>

          <div class="divide-y divide-gray-200 md:border-t-0">
            {% for item in cart.items %}
              <!-- Add data-line-index and data-variant-id here for JS -->
              <div
                class="p-5 grid grid-cols-12 items-center gap-5 cart-line"
                data-line-index="{{ forloop.index }}"
                data-line-key="{{ item.key }}"
                data-variant-id="{{ item.variant_id }}">
                <a href="{{ item.url }}" class="col-span-2 block w-24 h-24 bg-white border border-gray-200 rounded overflow-hidden shrink-0 ml-3">
                  {% if item.image %}
                    {{ item.image | image_url: width: 200 | image_tag: class: 'w-full h-full object-contain' }}
                  {% endif %}
                </a>

                <div class="col-span-5 min-w-0">
                  <a href="{{ item.url }}" class="text-[#797979] text-sm  line-clamp-2">{{ item.product.title }}</a>
                  {% if item.variant.title != 'Default Title' %}
                    <p class="mt-0.5 text-xs text-[#797979]">{{ item.variant.title }}</p>
                  {% endif %}
                  <div class="mt-3 flex items-center gap-4 md:hidden">
                    <!-- Mobile quantity -->
                    <div class="flex items-center border border-gray-300 rounded overflow-hidden">
                      <button
                        type="button"
                        class="w-9 h-9 grid place-content-center text-gray-600 mobile-qty-decrease"
                        data-change="minus">âˆ’</button>
                      <input
                        class="w-12 h-9 text-center text-sm outline-none border-x border-gray-300 mobile-qty-input"
                        type="number"
                        min="0"
                        value="{{ item.quantity }}"
                        data-line-index="{{ forloop.index }}">
                      <button
                        type="button"
                        class="w-9 h-9 grid place-content-center text-gray-600 mobile-qty-increase"
                        data-change="plus">+</button>
                    </div>
                    <a
                      href="{{ item.url_to_remove }}"
                      class="text-sm text-rose-600 hover:underline cart-remove-link"
                      data-line-index="{{ forloop.index }}">{{ 'cart.remove' | t | default: 'Remove' }}</a>
                  </div>
                </div>

                <div class="hidden md:block col-span-2 font-medium text-sm text-center text-[#2A2A2A] unit-price">{{ item.final_price | money }}</div>

                <div class="hidden md:flex col-span-1 items-center justify-center">
                  <div class="relative">
                    <input
                      type="number"
                      min="0"
                      value="{{ item.quantity }}"
                      class="cart-qty-input w-[80px] h-[40px] rounded-md font-semibold border border-[#e7e7e7] bg-white pl-3 text-[12px] leading-none text-gray-900 text-left outline-none appearance-none qty-input-desktop"
                      data-line-index="{{ forloop.index }}">
                    <div class="absolute inset-y-0 right-0 w-[21px] flex flex-col rounded-r-[14px] overflow-hidden">
                      <button
                        type="button"
                        class="flex-1 grid place-content-center qty-plus"
                        aria-label="Increase quantity"
                        data-line-index="{{ forloop.index }}">
                        {% render 'icon-chevron-up' %}
                      </button>
                      <button
                        type="button"
                        class="flex-1 grid place-content-center qty-minus"
                        aria-label="Decrease quantity"
                        data-line-index="{{ forloop.index }}">
                        {% render 'icon-chevron-down' %}
                      </button>
                    </div>
                  </div>
                </div>

                <div class="col-span-2 text-right text-gray-900 font-medium line-total">{{ item.final_line_price | money }}</div>

                <!-- hidden input for forms (keeps existing POST behaviour) -->
                <input
                  type="hidden"
                  name="updates[{{ item.key }}]"
                  value="{{ item.quantity }}">
              </div>
            {% endfor %}
          </div>

          <!-- Controls row -->
          <div class="mt-4 border-t border-b py-3 border-gray-300 ">
            <div class="my-5 grid px-5 md:grid-cols-2 gap-3 items-center">
              <div>
                <input
                  type="submit"
                  id="update-cart-btn"
                  class="inline-flex uppercase bg-[#F6F6F6] text-sm font-medium h-10 px-10 items-center justify-center cursor-pointer text-[#2A2A2A] rounded hover:border-gray-400"
                  value="Update Cart"
                  data-cart-update>
              </div>

              <!-- Discount controls (single message element used) -->
              <div class="flex items-center justify-start md:justify-end gap-3">
                <input
                  id="cart-discount-code"
                  class="h-10 w-50 border border-[#CCCCCC] rounded text-[#2A2A2A] px-3 text-sm"
                  placeholder="Coupon Code"
                  aria-label="Discount code">
                <button
                  type="button"
                  id="apply-coupon-btn"
                  class="h-10 cursor-pointer uppercase font-medium px-6 bg-[#71CD14] text-white rounded text-xs">
                  Apply
                </button>
                <button
                  type="button"
                  id="remove-coupon-btn"
                  class="h-10 cursor-pointer uppercase font-medium px-5 bg-[#F6F6F6] text-gray-900 rounded text-xs">
                  Remove
                </button>
                <p id="cart-discount-message" class="text-xs text-green-600 hidden ml-3"></p>
              </div>
            </div>
          </div>

          <!-- Subtotal row -->
          <div class="flex items-center justify-end gap-28 text-sm px-5 py-3 mt-4">
            <span class="text-gray-900 font-semibold">Subtotal</span>
            <div class="flex flex-col items-end">
              <span
                id="cart-subtotal"
                class="text-gray-900 font-semibold"
                data-total-cents="{{ cart.total_price }}">
                {{ cart.total_price | money }}
              </span>
            </div>
          </div>

          <!-- Shipping options (UI only) -->
          <div class="mt-7 border-t border-gray-300 pt-5 px-5">
            <div class="flex gap-[45px] justify-end">
              <h4 class="text-gray-900 font-semibold text-sm">Shipping</h4>
              <ul class="space-y-2 text-sm">
                <li>
                  <label for="ship-flat5" class="ship-option">
                    <span class="ship-label text-[#797979]">Flat Rate: $5.00</span>
                    <input
                      id="ship-flat5"
                      type="radio"
                      name="ship">
                    <span class="ship-radio" aria-hidden="true"></span>
                  </label>
                </li>
                <li>
                  <label for="ship-free" class="ship-option">
                    <span class="ship-label text-[#797979]">Free Shipping</span>
                    <input
                      id="ship-free"
                      type="radio"
                      name="ship">
                    <span class="ship-radio" aria-hidden="true"></span>
                  </label>
                </li>
                <li>
                  <label for="ship-flat10" class="ship-option">
                    <span class="ship-label text-[#797979]">Flat Rate: $10.00</span>
                    <input
                      id="ship-flat10"
                      type="radio"
                      name="ship">
                    <span class="ship-radio" aria-hidden="true"></span>
                  </label>
                </li>
                <li>
                  <label for="ship-local2" class="ship-option">
                    <span class="ship-label text-[#797979]">Local Delivery: $2.00</span>
                    <input
                      id="ship-local2"
                      type="radio"
                      name="ship"
                      checked>
                    <span class="ship-radio" aria-hidden="true"></span>
                  </label>
                </li>
              </ul>
            </div>

            <!-- Calculate shipping (UI only) -->
            <div class="flex justify-end">
              <div class="mt-4 flex flex-col w-[310px]">
                <div class="flex items-center justify-end mb-3 mt-1 gap-2 text-xs font-medium text-[#2A2A2A]">
                  <span>Calculate Shipping</span>
                  {% render 'icon-caret' %}
                </div>
                <div class="mt-2 space-y-4">
                  <!-- Country dropdown -->
                  <div
                    class="dd dd-compact"
                    data-dd
                    id="dd-country">
                    <button
                      class="dd-btn"
                      type="button"
                      aria-haspopup="listbox"
                      aria-expanded="false">
                      <span class="dd-value">Bangladesh</span>
                      {% render 'icon-caret'
                        , class: 'dd-caret' %}
                    </button>
                    <div class="dd-menu" role="listbox">
                      <button class="dd-item" role="option">Bangladesh</button>
                      <button class="dd-item" role="option">India</button>
                      <button class="dd-item" role="option">Pakistan</button>
                    </div>
                  </div>

                  <!-- State dropdown -->
                  <div
                    class="dd dd-compact"
                    data-dd
                    id="dd-state">
                    <button
                      class="dd-btn"
                      type="button"
                      aria-haspopup="listbox"
                      aria-expanded="false">
                      <span class="dd-value">Select a State</span>
                      {% render 'icon-caret'
                        , class: 'dd-caret' %}
                    </button>
                    <div class="dd-menu" role="listbox">
                      <button class="dd-item" role="option">Select a State</button>
                      <button class="dd-item" role="option">State 1</button>
                      <button class="dd-item" role="option">State 2</button>
                      <button class="dd-item" role="option">State 3</button>
                    </div>
                  </div>
                  <input class="custom-input" placeholder="Postcode/Zipcode">
                  <div class="flex items-center justify-end">
                    <button type="button" class="h-[44px] bg-[#F6F6F6] hover:text-[#0056B3] text-[#2A2A2A] text-sm font-medium rounded-sm cursor-pointer py-2 px-10">Update Details</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
          <div class="mt-6 px-5 border-t border-gray-300 pt-5 pb-20">
            <div class="flex justify-end px-5 gap-3">
              <div>
                <a href="{{ routes.all_products_collection_url }}" class="bg-[#F6F6F6] hover:text-[#0056B3] text-[#2A2A2A] text-sm font-medium rounded-sm cursor-pointer py-3 px-10">Continue Shopping</a>

                <!-- checkout button: we'll update its formaction when a discount code is applied -->
                <button
                  type="submit"
                  name="checkout"
                  id="checkout-btn"
                  formaction="/checkout"
                  class="h-[44px] bg-[#71cd13] text-white hover:text-[#71cd13] hover:bg-transparent border border-[#71cd13] transition-colors duration-300 ease-in text-sm font-medium rounded-sm cursor-pointer py-2 px-10">Proceed to Checkout</button>

              </div>
            </div>
          </div>
        </div>
      </form>

  <script>
(() => {
  // Selectors
  const SUBTOTAL_EL = document.getElementById('cart-subtotal');
  const APPLY_BTN = document.getElementById('apply-coupon-btn');
  const REMOVE_BTN = document.getElementById('remove-coupon-btn');
  const DISCOUNT_INPUT = document.getElementById('cart-discount-code');
  const DISCOUNT_MSG = document.getElementById('cart-discount-message');
  const CHECKOUT_BTN = document.getElementById('checkout-btn');
  const UPDATE_CART_BTN = document.getElementById('update-cart-btn');

  // Utilities
  function centsToMoney(cents) {
    return (cents / 100).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function showDiscountMessage(text, isError = false) {
    if (!DISCOUNT_MSG) return;
    DISCOUNT_MSG.textContent = text;
    DISCOUNT_MSG.classList.remove('hidden');
    DISCOUNT_MSG.style.color = isError ? '#f44336' : '#2e7d32';
  }

  function hideDiscountMessage() {
    if (!DISCOUNT_MSG) return;
    DISCOUNT_MSG.textContent = '';
    DISCOUNT_MSG.classList.add('hidden');
  }

  // Fetch the current cart JSON and update UI (subtotal, line totals)
  async function refreshCartUI() {
    try {
      const res = await fetch('/cart.js');
      if (!res.ok) throw new Error('Failed to fetch cart');
      const cart = await res.json();

      // update subtotal
      if (SUBTOTAL_EL) {
        SUBTOTAL_EL.textContent = `${(cart.currency || '')} ${centsToMoney(cart.total_price)}`.trim();
        SUBTOTAL_EL.setAttribute('data-total-cents', cart.total_price);
      }

      // update line totals and unit prices
      document.querySelectorAll('.cart-line').forEach(line => {
        const idx = parseInt(line.getAttribute('data-line-index'), 10);
        const item = cart.items[idx - 1];
        if (!item) return;
        const unitEl = line.querySelector('.unit-price');
        const totalEl = line.querySelector('.line-total');
        const qtyInputs = line.querySelectorAll('[data-line-index]');

        if (unitEl) unitEl.textContent = item.price ? (item.price_money ? item.price_money : `${centsToMoney(item.price)}`) : (item.final_price ? `${centsToMoney(item.final_price)}` : '');
        if (totalEl) totalEl.textContent = item.final_line_price ? `${centsToMoney(item.final_line_price)}` : '';
        if (item.final_line_price != null && totalEl) totalEl.textContent = `${centsToMoney(item.final_line_price)}`;

        qtyInputs.forEach(inp => {
          if ('value' in inp) inp.value = item.quantity;
        });
      });

      // -------------------------------
      //  CHECK INVALID / EXPIRED COUPON
      // -------------------------------
      const appliedCode = localStorage.getItem('applied_discount_code');

      if (appliedCode) {
        const discountAmount = cart.total_discount || 0;

        if (discountAmount > 0) {
          showDiscountMessage(`Discount "${appliedCode}" applied!`, false);
        } else {
          showDiscountMessage(`"${appliedCode}" is invalid or expired`, true);

          if (CHECKOUT_BTN) {
            CHECKOUT_BTN.setAttribute('formaction', '/checkout');
          }

          localStorage.removeItem('applied_discount_code');
          const clean = new URL(window.location.href);
          clean.searchParams.delete('discount');
          window.history.replaceState({}, '', clean.toString());
        }
      }

    } catch (err) {
      console.error('refreshCartUI err', err);
    }
  }

  // Change single line (using /cart/change.js)
  async function changeLineQuantity(line, quantity) {
    try {
      const body = new URLSearchParams();
      body.append('line', String(line));
      body.append('quantity', String(quantity));

      const res = await fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error('Failed to change line: ' + txt);
      }

      await refreshCartUI();
    } catch (err) {
      console.error('changeLineQuantity err', err);
      showDiscountMessage('Could not update quantity', true);
    }
  }

  // Bulk update using /cart/update.js with updates map variant_id -> qty
  async function updateCartBulk(updates) {
    try {
      const payload = { updates: updates };

      const res = await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error('Failed to update cart: ' + txt);
      }

      await refreshCartUI();
      showDiscountMessage('Cart updated', false);
      setTimeout(hideDiscountMessage, 2500);
    } catch (err) {
      console.error('updateCartBulk err', err);
      showDiscountMessage('Could not update cart', true);
    }
  }

  // Apply coupon
  async function applyCouponCode(code) {
    hideDiscountMessage();

    if (!code) {
      showDiscountMessage("Please enter a coupon code", true);
      return;
    }

    try {
      const beforeRes = await fetch("/cart.js");
      const beforeCart = await beforeRes.json();
      const beforeCodes = beforeCart.discount_codes?.map(c => c.code.toLowerCase()) || [];

      const updateRes = await fetch("/cart/update.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ discount: code })
      });

      const afterCart = await updateRes.json();
      const discountAmount = afterCart.total_discount || 0;

      if (discountAmount > 0) {
        localStorage.setItem("applied_discount_code", code);

        if (CHECKOUT_BTN) {
          const checkoutUrl = new URL("/checkout", window.location.origin);
          checkoutUrl.searchParams.set("discount", code);
          CHECKOUT_BTN.setAttribute("formaction", checkoutUrl.toString());
        }

        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("discount", code);
        window.history.replaceState({}, "", currentUrl.toString());

        showDiscountMessage(`Discount "${code}" applied!`, false);
      } else {
        showDiscountMessage("Invalid or expired discount code.", true);

        localStorage.removeItem("applied_discount_code");
        if (CHECKOUT_BTN) CHECKOUT_BTN.setAttribute("formaction", "/checkout");

        const cleanUrl = new URL(window.location.href);
        cleanUrl.searchParams.delete("discount");
        window.history.replaceState({}, "", cleanUrl.toString());
      }

      refreshCartUI();

    } catch (err) {
      console.error("applyCouponCode err", err);
      showDiscountMessage("Could not apply discount", true);
    }
  }

  async function removeCouponCodeUI() {
    hideDiscountMessage();

    try {
      await fetch("/cart/update.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ discount: "" })
      });

      localStorage.removeItem("applied_discount_code");

      if (CHECKOUT_BTN) CHECKOUT_BTN.setAttribute("formaction", "/checkout");

      const cleanUrl = new URL(window.location.href);
      cleanUrl.searchParams.delete("discount");
      window.history.replaceState({}, "", cleanUrl.toString());

      showDiscountMessage("Coupon removed", false);
      setTimeout(hideDiscountMessage, 2000);

      refreshCartUI();

    } catch (err) {
      console.error("removeCouponCodeUI err", err);
      showDiscountMessage("Could not remove discount", true);
    }
  }

  // --- EVENTS ---
  if (APPLY_BTN) {
    APPLY_BTN.addEventListener("click", function () {
      const code = (DISCOUNT_INPUT && DISCOUNT_INPUT.value || "").trim();
      applyCouponCode(code);
    });
  }

  if (REMOVE_BTN) {
    REMOVE_BTN.addEventListener("click", removeCouponCodeUI);
  }

  // Auto-apply discount if already in URL or localStorage
  const urlParams = new URLSearchParams(window.location.search);
  const auto = urlParams.get("discount") || localStorage.getItem("applied_discount_code");
  if (auto) {
    if (DISCOUNT_INPUT) DISCOUNT_INPUT.value = auto;
    applyCouponCode(auto);
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.mobile-qty-decrease').forEach(btn => {
      btn.addEventListener('click', () => {
        const line = parseInt(btn.closest('.cart-line').getAttribute('data-line-index'), 10);
        const input = btn.closest('.cart-line').querySelector('.mobile-qty-input');
        const current = parseInt(input.value || '0', 10);
        const next = Math.max(0, current - 1);
        changeLineQuantity(line, next);
      });
    });

    document.querySelectorAll('.mobile-qty-increase').forEach(btn => {
      btn.addEventListener('click', () => {
        const line = parseInt(btn.closest('.cart-line').getAttribute('data-line-index'), 10);
        const input = btn.closest('.cart-line').querySelector('.mobile-qty-input');
        const current = parseInt(input.value || '0', 10);
        const next = Math.max(0, current + 1);
        changeLineQuantity(line, next);
      });
    });

    document.querySelectorAll('.qty-plus').forEach(btn => {
      btn.addEventListener('click', () => {
        const line = parseInt(btn.getAttribute('data-line-index'), 10);
        const input = document.querySelector('.qty-input-desktop[data-line-index="'+line+'"]');
        const cur = parseInt(input.value || '0', 10);
        changeLineQuantity(line, Math.max(0, cur + 1));
      });
    });

    document.querySelectorAll('.qty-minus').forEach(btn => {
      btn.addEventListener('click', () => {
        const line = parseInt(btn.getAttribute('data-line-index'), 10);
        const input = document.querySelector('.qty-input-desktop[data-line-index="'+line+'"]');
        const cur = parseInt(input.value || '0', 10);
        changeLineQuantity(line, Math.max(0, cur - 1));
      });
    });

    document.querySelectorAll('.qty-input-desktop').forEach(input => {
      input.addEventListener('change', () => {
        const line = parseInt(input.getAttribute('data-line-index'), 10);
        let v = parseInt(input.value || '0', 10);
        if (isNaN(v) || v < 0) v = 0;
        changeLineQuantity(line, v);
      });
    });

    if (UPDATE_CART_BTN) {
      UPDATE_CART_BTN.closest('form').addEventListener('submit', function(e){});
      UPDATE_CART_BTN.addEventListener('click', function(e){
        e.preventDefault();
        const updates = {};
        document.querySelectorAll('.cart-line').forEach(line => {
          const variantId = line.getAttribute('data-variant-id');
          const qtyInput = line.querySelector('.qty-input-desktop') || line.querySelector('.mobile-qty-input');
          if (!variantId || !qtyInput) return;
          const q = parseInt(qtyInput.value || '0', 10) || 0;
          updates[variantId] = q;
        });
        updateCartBulk(updates);
      });
    }

    refreshCartUI();
  });
})();
</script>



      <style>
        /* Toast container */
        #toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
        }
        .toast {
          display: inline-block;
          background-color: #333;
          color: #fff;
          padding: 12px 20px;
          margin-top: 10px;
          border-radius: 5px;
          opacity: 0.95;
          transition: transform 0.3s ease
          , opacity 0.3s ease;
        }
        .toast.success {
          background-color: #4CAF50;
        }
        .toast.error {
          background-color: #F44336;
        }
      </style>


      <style>
        [data-cart-root].is-loading {
          opacity: 0.6;
          pointer-events: none;
        }
        /* Hide native number input controls; we use our own chevrons */
        .cart-qty-input::-webkit-outer-spin-button,
        .cart-qty-input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        .cart-qty-input {
          -moz-appearance: textfield;
        }
        /* Hover shadow for small icon tiles (lower-left) */
        .tile-btn {
          transition: box-shadow 220ms ease
          , transform 220ms ease
          , background-color 220ms ease;
          box-shadow: none;
        }
        .tile-btn:hover {
          box-shadow: -20px 20px 30px rgba(0, 0, 0, 0.16);
        }
        /* Custom shipping radios */
        .ship-option {
          display: flex;
          align-items: center;
          justify-content: end;
          gap: 5px;
          cursor: pointer;
          user-select: none;
        }

        .ship-option input[type="radio"] {
          position: absolute;
          opacity: 0;
          width: 0;
          height: 0;
          pointer-events: none;
        }

        .ship-option .ship-radio {
          width: 12px;
          height: 12px;
          border: 1px solid #dcdcdc;
          /* light gray ring like reference */
          border-radius: 9999px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: #fff;
          box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.02);
        }

        .ship-option input[type="radio"]:checked + .ship-radio {
          border-color: #71CD14;
          /* green ring */
        }

        .ship-option input[type="radio"]:checked + .ship-radio::after {
          content: "";
          width: 6px;
          height: 6px;
          border-radius: 9999px;
          background: #71CD14;
          /* green dot */
          display: block;
        }

        /* Custom dropdown (compact to 34px) */
        .dd {
          position: relative;
          display: inline-block;
          width: 100%;
        }
        .dd.dd-compact .dd-btn {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 16px;
          width: 100%;
          height: 39px;
          padding: 0 18px 0 16px;
          border-radius: 7px;
          background: #F6F6F6;
          color: #959595;
          font-size: 13px;
          line-height: 1;
          border: 1px solid #e6e6e6;
        }
        .dd .dd-btn:focus {
          outline: none;
          border-color: #d0d0d0;
        }
        .dd .dd-caret {
          width: 12px;
          height: 12px;
          color: #bdbdbd;
          transition: transform 180ms ease;
        }
        .dd[aria-open="true"] .dd-caret {
          transform: rotate(180deg);
        }
        .dd .dd-menu {
          position: absolute;
          left: 0;
          top: calc(100% + 2px);
          z-index: 30;
          min-width: 100%;
          background: #fff;
          border: 1px solid #e6e6e6;
          border-radius: 6px;
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
          padding: 6px 0;
          display: none;
        }
        .dd[aria-open="true"] .dd-menu {
          display: block;
        }
        .dd .dd-item {
          display: block;
          width: 100%;
          text-align: left;
          padding: 10px 16px;
          font-size: 13px;
          color: #444;
        }
        .dd .dd-item:hover {
          background: #f7f7f7;
          color: #111;
        }

        /* Calculate shipping controls */
        .select-wrap {
          position: relative;
        }
        .custom-select,
        .custom-input {
          height: 34px;
          width: 100%;
          cursor: pointer;
          border: 1px solid #e6e6e6;
          padding: 0 36px 0 16px;
          font-size: 13px;
          color: #959595;
          background: #F6F6F6;
          transition: border-color 150ms ease;
        }
        .custom-input {
          padding-right: 12px;
        }
        .custom-select {
          -webkit-appearance: none;
          appearance: none;
          background-image: url("data:image/svg+xml;charset=UTF-8, %3csvg width='12' height='8' viewBox='0 0 12 8' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M1 1.5l5 5 5-5' stroke='%23bdbdbd' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
          background-repeat: no-repeat;
          background-position: right 12px center;
          background-size: 12px 8px;
        }
        .custom-input::placeholder {
          color: #999;
        }
        .custom-select:focus,
        .custom-input:focus {
          outline: none;
          border-color: #d0d0d0;
        }
        .custom-select:hover,
        .custom-input:hover {
          border-color: #d8d8d8;
        }
      </style>


      <script>
        (function(){
          function $all(sel){ return document.querySelectorAll(sel); }
          // Lightweight dropdown initialization (no external deps)
          function initDropdown(dd){
            if (!dd) return;
            var btn = dd.querySelector('.dd-btn');
            var valueEl = dd.querySelector('.dd-value');
            var menu = dd.querySelector('.dd-menu');
            function open(){ dd.setAttribute('aria-open', 'true'); btn.setAttribute('aria-expanded','true'); }
            function close(){ dd.removeAttribute('aria-open'); btn.setAttribute('aria-expanded','false'); }
            btn.addEventListener('click', function(e){
              e.stopPropagation();
              if (dd.getAttribute('aria-open') === 'true') close(); else open();
            });
            dd.querySelectorAll('.dd-item').forEach(function(item){
              item.addEventListener('click', function(e){
                e.preventDefault();
                if (valueEl) valueEl.textContent = item.textContent.trim();
                close();
              });
            });
            document.addEventListener('click', function(e){
              if (!dd.contains(e.target)) close();
            });
            // keyboard
            btn.addEventListener('keydown', function(e){ if (e.key === 'Escape') close(); });
          }
          initDropdown(document.getElementById('dd-country'));
          initDropdown(document.getElementById('dd-state'));
          function syncInputs(idx, newVal){
            var inputs = document.querySelectorAll('[data-qty-input-idx="'+idx+'"]');
            inputs.forEach(function(i){ i.value = newVal; });
            var hidden = document.querySelector('[data-qty-submit-idx="'+idx+'"]');
            if (hidden) hidden.value = newVal;
          }
          $all('[data-qty-minus-idx]').forEach(function(btn){
            btn.addEventListener('click', function(){
              var idx = btn.getAttribute('data-qty-minus-idx');
              var input = document.querySelector('[data-qty-input-idx="'+idx+'"]');
              if (!input) return; var v = parseInt(input.value||'1',10);
              v = Math.max(0, v-1); syncInputs(idx, v);
            });
          });
          $all('[data-qty-plus-idx]').forEach(function(btn){
            btn.addEventListener('click', function(){
              var idx = btn.getAttribute('data-qty-plus-idx');
              var input = document.querySelector('[data-qty-input-idx="'+idx+'"]');
              if (!input) return; var v = parseInt(input.value||'1',10);
              v = Math.max(0, v+1); syncInputs(idx, v);
            });
          });
          // Sync when user types
          $all('[data-qty-input-idx]').forEach(function(input){
            input.addEventListener('input', function(){
              var idx = input.getAttribute('data-qty-input-idx');
              var v = parseInt(input.value||'0',10); if (isNaN(v) || v < 0) v = 0;
              syncInputs(idx, v);
            });
          });
        })();
      </script>
    {% endif %}
  </div>
</section>

{% schema %}
  {
    "name": "Cart",
    "settings": []
  }
{% endschema %}