<script>
  (function(){
    function getWishlist(){
      try{
        var raw = localStorage.getItem('wishlist_handles') || '[]';
        var list = Array.isArray(raw) ? raw : JSON.parse(raw);
        return list.map(function(x){ return (x||'').toString().trim().toLowerCase(); });
      }catch(e){ return []; }
    }
    function setWishlist(list){
      try{ localStorage.setItem('wishlist_handles', JSON.stringify(list || [])); }catch(e){}
    }
    function refreshWishlistButtons(){
      var list = getWishlist();
      document.querySelectorAll('[data-wishlist]').forEach(function(btn){
        var h = (btn.getAttribute('data-product-handle') || '').trim().toLowerCase();
        var inList = h && list.indexOf(h) !== -1;
        btn.disabled = inList;
        btn.setAttribute('aria-pressed', inList ? 'true' : 'false');
        btn.classList.toggle('opacity-60', inList);
        btn.classList.toggle('pointer-events-none', inList);
      });
    }
    
    // --- Modal Elements ---
    var overlay = document.getElementById('quickview-overlay');
    var modal = document.getElementById('quickview-modal');
    var titleEl = document.getElementById('qv-title');
    var imgEl = document.getElementById('qv-image');
    var priceEl = document.getElementById('qv-price');
    var compareEl = document.getElementById('qv-compare');
    var descEl = document.getElementById('qv-desc');
    var viewEl = document.getElementById('qv-view');
    var addEl = document.getElementById('qv-add');
    var currentVariantId = null;
  
    // --- UPDATED money FUNCTION FOR RELIABILITY ---
    function money(cents){
      // Use Shopify global variables if available, otherwise use safer defaults
      var currencyCode = (window.Shopify && window.Shopify.currency) ? window.Shopify.currency.active : 'USD';
      var locale = 'en-US';
      var fallbackSymbol = 'Rs.'; // Default fallback symbol based on your previous code

      try { 
        return new Intl.NumberFormat(locale, { 
          style: 'currency', 
          currency: currencyCode 
        }).format(cents/100); 
      }
      catch(e){ 
        return fallbackSymbol + (cents/100).toFixed(2); 
      }
    }
  
    function openModal(){
      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      overlay.classList.add('hidden');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
      // Reset button state on close
      if (addEl) {
        addEl.textContent = 'Add to cart';
        addEl.disabled = false;
        addEl.classList.remove('opacity-50', 'pointer-events-none');
      }
    }
    [overlay, modal.querySelector('[data-qv-close]')].forEach(function(el){
      if (el) el.addEventListener('click', function(e){
        if (e.target === overlay || e.currentTarget.hasAttribute('data-qv-close')) closeModal();
      });
    });
  
    async function fetchProduct(handle){
      var res = await fetch('/products/' + handle + '.js', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load product');
      return await res.json();
    }
  
    // --- UPDATED onQuickView FUNCTION ---
    async function onQuickView(handle){
      try{
        var p = await fetchProduct(handle);
        
        // 1. Update Basic Info
        titleEl.textContent = p.title;
        viewEl.href = p.url || ('/products/' + handle);
        descEl.textContent = (p.description || '').replace(/<[^>]*>?/gm,'').substring(0, 240);
        
        // 2. Variant & Price Handling
        var defaultVariant = null;
        var isAvailable = false;
        
        if (p.variants && p.variants.length){
          // Find the first available variant, otherwise use the first variant
          defaultVariant = p.variants.find(function(x){ return x.available; }) || p.variants[0];
          isAvailable = defaultVariant && defaultVariant.available;
          
          currentVariantId = defaultVariant ? defaultVariant.id : null;
          
          priceEl.textContent = defaultVariant ? money(defaultVariant.price) : 'Sold Out';
          compareEl.innerHTML = (defaultVariant && defaultVariant.compare_at_price > defaultVariant.price) ? 
                                  '<del>'+ money(defaultVariant.compare_at_price) +'</del>' : '';
          
          // Update media
          var img = defaultVariant.featured_image ? defaultVariant.featured_image.src : ((p.images && p.images.length) ? p.images[0] : null);
          imgEl.src = img || '';
          imgEl.alt = p.title;
          
        } else {
          currentVariantId = null;
          priceEl.textContent = 'Sold Out';
          compareEl.textContent = '';
        }

        // 3. Update Add to Cart Button State
        if (isAvailable) {
          addEl.textContent = "Add to cart";
          addEl.disabled = false;
          addEl.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          addEl.textContent = "Sold Out";
          addEl.disabled = true;
          addEl.classList.add('opacity-50', 'pointer-events-none');
        }

        // 4. ATTACH/RE-ATTACH THE ADD TO CART HANDLER
        addEl.onclick = function(){
          if (!currentVariantId || addEl.disabled) return;
          
          // Temporary button state change to indicate loading
          addEl.textContent = "Adding...";
          addEl.disabled = true;

          var addPromise;
          if (window.ShopCart && typeof window.ShopCart.add === 'function') {
            addPromise = window.ShopCart.add({ id: currentVariantId, quantity: 1 });
          } else {
            addPromise = fetch('/cart/add.js', { 
                  method:'POST', 
                  headers:{'Content-Type':'application/json'}, 
                  body: JSON.stringify({ id: currentVariantId, quantity: 1 }) 
                })
                .then(function(r){ 
                  if (!r.ok) {
                    // Check for detailed error description from Shopify
                    return r.json().then(function(err) { throw new Error(err.description || 'Request failed'); });
                  }
                  return r.json(); 
                })
                .then(function(){ 
                  try { window.dispatchEvent(new CustomEvent('cart:updated')); } catch(err) {} 
                });
          }
          
          Promise.resolve(addPromise)
            .then(function(){ 
              // Revert button state and close modal on success
              addEl.textContent = "Added!";
              closeModal(); 
              // Show toast notification
              try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: 'Item added to cart' } })); } catch(err) {}
            })
            .catch(function(error){ 
              console.error("Add to cart error:", error);
              // Revert button text and re-enable on failure
              addEl.textContent = "Error!";
              addEl.disabled = false;
              addEl.classList.remove('opacity-50', 'pointer-events-none');
              
              // Show error toast notification
              try { 
                window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: error.message || 'Could not add to cart' } })); 
              } catch(err) {}
            });
        };
        
        // 5. Open Modal
        openModal();
      }catch(e){
        console.error("Quickview Load Error:", e);
        closeModal();
        try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: 'Could not load product details.' } })); } catch(err) {}
      }
    }
  
    document.addEventListener('click', function(e){
      var btn = e.target.closest('[data-quickview]');
      if (btn){
        e.preventDefault();
        var handle = btn.getAttribute('data-product-handle');
        if (handle) onQuickView(handle);
      }
      var wish = e.target.closest('[data-wishlist]');
      if (wish){
        e.preventDefault();
        var h = (wish.getAttribute('data-product-handle') || '').trim().toLowerCase();
        try{
          var list = getWishlist();
          // normalize + de-duplicate
          list = list.filter(Boolean);
          if (h && list.indexOf(h) === -1) list.push(h);
          setWishlist(list);
          if (wish.classList) wish.classList.add('text-[#71cd13]');
          try { window.dispatchEvent(new CustomEvent('wishlist:updated', { detail: { handle: h, list: list } })); } catch(err) {}
          try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: 'Added to wishlist' } })); } catch(err) {}
          refreshWishlistButtons();
        }catch(err){}
      }
      var add = e.target.closest('[data-quick-add]');
      if (add){
        e.preventDefault();
        var vid = add.getAttribute('data-variant-id');
        if (vid){
          var addPromise;
          if (window.ShopCart && typeof window.ShopCart.add === 'function') {
            addPromise = window.ShopCart.add({ id: Number(vid), quantity: 1 });
          } else {
            addPromise = fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: Number(vid), quantity: 1 }) })
              .then(function(r){ 
                if (!r.ok) {
                  return r.json().then(function(err) { throw new Error(err.description || 'Request failed'); });
                }
                return r.json(); 
              })
              .then(function(){ try { window.dispatchEvent(new CustomEvent('cart:updated')); } catch(err) {} });
          }
          Promise.resolve(addPromise)
            .then(function(){
              try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: 'Added to cart' } })); } catch(err) {}
            })
            .catch(function(error){
              console.error("Quick add error:", error);
              try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: error.message || 'Could not add to cart' } })); } catch(err) {}
            });
        }
      }
    }, true);

    // initialize button states
    document.addEventListener('DOMContentLoaded', refreshWishlistButtons);
    window.addEventListener('wishlist:updated', refreshWishlistButtons);
  })();
</script>