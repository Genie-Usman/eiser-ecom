<div
  id="quickview-overlay"
  class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/40 px-4 py-8 backdrop-blur-sm">
  <div
    id="quickview-modal"
    class="relative hidden w-full max-w-5xl overflow-hidden rounded-2xl bg-white shadow-2xl transition-all duration-200">
    <button
      type="button"
      class="absolute right-4 top-4 z-10 inline-flex h-9 w-9 items-center justify-center rounded-full bg-white/70 text-gray-500 hover:text-gray-900"
      data-qv-close
      aria-label="{{ 'general.accessibility.close' | t }}">
      {% render 'icon-close' %}
    </button>
    <div class="grid gap-0 md:grid-cols-2">
      <div class="flex items-center justify-center bg-gray-50 p-6 md:p-10">
        <img
          id="qv-image"
          src="{{ 'quick-view-placeholder.svg' | asset_url }}"
          alt=""
          class="max-h-[420px] w-full object-contain"
          loading="lazy"
          width="600"
          height="600" />
      </div>
      <div class="flex flex-col gap-4 p-6 md:p-10">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-500">
          {{ 'products.quick_view.heading' | t }}
        </p>
        <h3 id="qv-title" class="text-2xl font-semibold leading-tight text-[#2A2A2A]"></h3>
        <div class="flex items-center gap-4">
          <span id="qv-price" class="text-xl font-semibold text-[#2A2A2A]"></span>
          <span id="qv-compare" class="text-sm text-gray-400"></span>
        </div>
        <p id="qv-desc" class="text-sm leading-relaxed text-gray-600">
          {{ 'products.quick_view.description_fallback' | t }}
        </p>
        <div class="mt-auto flex flex-wrap gap-3 pt-2">
          <a
            id="qv-view"
            href="#"
            class="rounded border border-[#2A2A2A] px-5 py-3 text-xs font-semibold uppercase tracking-wide text-[#2A2A2A] transition-colors duration-200 hover:bg-[#2A2A2A] hover:text-white">
            {{ 'products.quick_view.view_product' | t }}
          </a>
          <button
            id="qv-add"
            type="button"
            class="rounded bg-[#71cd13] px-6 py-3 text-xs font-semibold uppercase tracking-wide text-white transition-colors duration-200 hover:bg-[#5fa610]">
            {{ 'products.quick_view.add_to_cart' | t }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    var qvStrings = {
      addToCart: {{ 'products.quick_view.add_to_cart' | t | json }},
      soldOut: {{ 'products.quick_view.sold_out' | t | json }},
      adding: {{ 'products.quick_view.adding' | t | json }},
      added: {{ 'products.quick_view.added' | t | json }},
      error: {{ 'products.quick_view.error' | t | json }},
      descriptionFallback: {{ 'products.quick_view.description_fallback' | t | json }},
      toastAdded: {{ 'products.quick_view.toast_added' | t | json }},
      wishlistAdded: {{ 'products.quick_view.wishlist_added' | t | json }},
      cartError: {{ 'products.quick_view.cart_error' | t | json }},
      loadError: {{ 'products.quick_view.load_error' | t | json }}
    };

    function announceCartChange(){
      try { window.dispatchEvent(new CustomEvent('cart:updated')); } catch(err) {}
      try { window.dispatchEvent(new CustomEvent('cart:refresh')); } catch(err) {}
    }

    function getWishlist(){
      try{
        var raw = localStorage.getItem('wishlist_handles') || '[]';
        var list = Array.isArray(raw) ? raw : JSON.parse(raw);
        return list.map(function(x){ return (x||'').toString().trim().toLowerCase(); });
      }catch(e){ return []; }
    }
    function setWishlist(list){
      try{ localStorage.setItem('wishlist_handles', JSON.stringify(list || [])); }catch(e){}
    }
    function refreshWishlistButtons(){
      var list = getWishlist();
      document.querySelectorAll('[data-wishlist]').forEach(function(btn){
        var h = (btn.getAttribute('data-product-handle') || '').trim().toLowerCase();
        var inList = h && list.indexOf(h) !== -1;
        btn.disabled = inList;
        btn.setAttribute('aria-pressed', inList ? 'true' : 'false');
        btn.classList.toggle('opacity-60', inList);
        btn.classList.toggle('pointer-events-none', inList);
      });
    }
    
    // --- Modal Elements ---
    var overlay = document.getElementById('quickview-overlay');
    var modal = document.getElementById('quickview-modal');
    var titleEl = document.getElementById('qv-title');
    var imgEl = document.getElementById('qv-image');
    var priceEl = document.getElementById('qv-price');
    var compareEl = document.getElementById('qv-compare');
    var descEl = document.getElementById('qv-desc');
    var viewEl = document.getElementById('qv-view');
    var addEl = document.getElementById('qv-add');
    var currentVariantId = null;
    var quickViewReady = overlay && modal && titleEl && imgEl && priceEl && compareEl && descEl && viewEl && addEl;
  
    // --- UPDATED money FUNCTION FOR RELIABILITY ---
    function money(cents){
      // Use Shopify global variables if available, otherwise use safer defaults
      var currencyCode = (window.Shopify && window.Shopify.currency) ? window.Shopify.currency.active : 'USD';
      var locale = 'en-US';
      var fallbackSymbol = 'Rs.'; // Default fallback symbol based on your previous code

      try { 
        return new Intl.NumberFormat(locale, { 
          style: 'currency', 
          currency: currencyCode 
        }).format(cents/100); 
      }
      catch(e){ 
        return fallbackSymbol + (cents/100).toFixed(2); 
      }
    }
  
    function openModal(){
      if (!quickViewReady) return;
      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      if (!quickViewReady) return;
      overlay.classList.add('hidden');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      // Reset button state on close
      if (addEl) {
        addEl.textContent = qvStrings.addToCart;
        addEl.disabled = false;
        addEl.classList.remove('opacity-50', 'pointer-events-none');
      }
    }
    if (overlay) {
      overlay.addEventListener('click', function(e){
        if (e.target === overlay) closeModal();
      });
    }
    if (modal) {
      modal.querySelectorAll('[data-qv-close]').forEach(function(el){
        el.addEventListener('click', function(){ closeModal(); });
      });
    }
  
    async function fetchProduct(handle){
      var res = await fetch('/products/' + handle + '.js', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load product');
      return await res.json();
    }
  
    // --- UPDATED onQuickView FUNCTION ---
    async function onQuickView(handle){
      if (!quickViewReady) return;
      try{
        var p = await fetchProduct(handle);
        
        // 1. Update Basic Info
        titleEl.textContent = p.title;
        viewEl.href = p.url || ('/products/' + handle);
        var desc = (p.description || '').replace(/<[^>]*>?/gm,'').trim();
        descEl.textContent = desc ? desc.substring(0, 240) : qvStrings.descriptionFallback;
        
        // 2. Variant & Price Handling
        var defaultVariant = null;
        var isAvailable = false;
        
        if (p.variants && p.variants.length){
          // Find the first available variant, otherwise use the first variant
          defaultVariant = p.variants.find(function(x){ return x.available; }) || p.variants[0];
          isAvailable = defaultVariant && defaultVariant.available;
          
          currentVariantId = defaultVariant ? defaultVariant.id : null;
          
          priceEl.textContent = defaultVariant ? money(defaultVariant.price) : 'Sold Out';
          compareEl.innerHTML = (defaultVariant && defaultVariant.compare_at_price > defaultVariant.price) ? 
                                  '<del>'+ money(defaultVariant.compare_at_price) +'</del>' : '';
          
          // Update media
          var img = defaultVariant.featured_image ? defaultVariant.featured_image.src : ((p.images && p.images.length) ? p.images[0] : null);
          imgEl.src = img || '';
          imgEl.alt = p.title;
          
        } else {
          currentVariantId = null;
          priceEl.textContent = 'Sold Out';
          compareEl.textContent = '';
        }

        // 3. Update Add to Cart Button State
        if (isAvailable) {
          addEl.textContent = qvStrings.addToCart;
          addEl.disabled = false;
          addEl.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          addEl.textContent = qvStrings.soldOut;
          addEl.disabled = true;
          addEl.classList.add('opacity-50', 'pointer-events-none');
        }

        // 4. ATTACH/RE-ATTACH THE ADD TO CART HANDLER
        addEl.onclick = function(){
          if (!currentVariantId || addEl.disabled) return;
          
          // Temporary button state change to indicate loading
          addEl.textContent = qvStrings.adding;
          addEl.disabled = true;

          var addPromise;
          if (window.ShopCart && typeof window.ShopCart.add === 'function') {
            addPromise = window.ShopCart.add({ id: currentVariantId, quantity: 1 });
          } else {
            addPromise = fetch('/cart/add.js', { 
                  method:'POST', 
                  headers:{'Content-Type':'application/json'}, 
                  body: JSON.stringify({ id: currentVariantId, quantity: 1 }) 
                })
                .then(function(r){ 
                  if (!r.ok) {
                    // Check for detailed error description from Shopify
                    return r.json().then(function(err) { throw new Error(err.description || 'Request failed'); });
                  }
                  return r.json(); 
                })
                .then(function(){ 
                });
          }
          
          Promise.resolve(addPromise)
            .then(function(){ 
              // Revert button state and close modal on success
              addEl.textContent = qvStrings.added;
              announceCartChange();
              closeModal(); 
              // Show toast notification
              try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: qvStrings.toastAdded } })); } catch(err) {}
            })
            .catch(function(error){ 
              console.error("Add to cart error:", error);
              // Revert button text and re-enable on failure
              addEl.textContent = qvStrings.error;
              addEl.disabled = false;
              addEl.classList.remove('opacity-50', 'pointer-events-none');
              
              // Show error toast notification
              try { 
                window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: error.message || qvStrings.cartError } })); 
              } catch(err) {}
            });
        };
        
        // 5. Open Modal
        openModal();
      }catch(e){
        console.error("Quickview Load Error:", e);
        closeModal();
        try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: qvStrings.loadError } })); } catch(err) {}
      }
    }
  
    document.addEventListener('click', function(e){
      var btn = e.target.closest('[data-quickview]');
      if (btn){
        if (!quickViewReady) return;
        e.preventDefault();
        var handle = btn.getAttribute('data-product-handle');
        if (handle) onQuickView(handle);
      }
      var wish = e.target.closest('[data-wishlist]');
      if (wish){
        e.preventDefault();
        var h = (wish.getAttribute('data-product-handle') || '').trim().toLowerCase();
        try{
          var list = getWishlist();
          // normalize + de-duplicate
          list = list.filter(Boolean);
          if (h && list.indexOf(h) === -1) list.push(h);
          setWishlist(list);
          if (wish.classList) wish.classList.add('text-[#71cd13]');
          try { window.dispatchEvent(new CustomEvent('wishlist:updated', { detail: { handle: h, list: list } })); } catch(err) {}
          try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: qvStrings.wishlistAdded } })); } catch(err) {}
          refreshWishlistButtons();
        }catch(err){}
      }
      var add = e.target.closest('[data-quick-add]');
      if (add){
        e.preventDefault();
        var vid = add.getAttribute('data-variant-id');
        if (vid){
          var addPromise;
          if (window.ShopCart && typeof window.ShopCart.add === 'function') {
            addPromise = window.ShopCart.add({ id: Number(vid), quantity: 1 });
          } else {
            addPromise = fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: Number(vid), quantity: 1 }) })
              .then(function(r){ 
                if (!r.ok) {
                  return r.json().then(function(err) { throw new Error(err.description || 'Request failed'); });
                }
                return r.json(); 
              });
          }
          Promise.resolve(addPromise)
            .then(function(){
              announceCartChange();
              try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: qvStrings.toastAdded } })); } catch(err) {}
            })
            .catch(function(error){
              console.error("Quick add error:", error);
              try { window.dispatchEvent(new CustomEvent('toast:show', { detail: { message: error.message || qvStrings.cartError } })); } catch(err) {}
            });
        }
      }
    }, true);

    // initialize button states
    document.addEventListener('DOMContentLoaded', refreshWishlistButtons);
    window.addEventListener('wishlist:updated', refreshWishlistButtons);
  })();
</script>